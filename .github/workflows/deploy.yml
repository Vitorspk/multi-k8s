name: Deploy to GKE

on:
  push:
    branches:
      - master
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME || 'multi-k8s-cluster' }}
  GKE_ZONE: ${{ secrets.GKE_ZONE || 'southamerica-east1-a' }}
  DEPLOYMENT_NAME: ${{ secrets.DEPLOYMENT_NAME || 'multi-k8s' }}

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        version: 'latest'

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker to use gcloud as credential helper
      run: |
        gcloud auth configure-docker

    - name: Check if GKE cluster exists
      id: check-cluster
      run: |
        if gcloud container clusters describe $GKE_CLUSTER --zone=$GKE_ZONE --project=$PROJECT_ID &>/dev/null; then
          echo "cluster_exists=true" >> $GITHUB_OUTPUT
          echo "✅ Cluster $GKE_CLUSTER exists in zone $GKE_ZONE"
        else
          echo "cluster_exists=false" >> $GITHUB_OUTPUT
          echo "❌ Cluster $GKE_CLUSTER does not exist in zone $GKE_ZONE"
          echo "⚠️  Please run Terraform first to create the infrastructure:"
          echo "   cd terraform && terraform init && terraform apply"
        fi

    - name: Get GKE credentials
      if: steps.check-cluster.outputs.cluster_exists == 'true'
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE --project $PROJECT_ID

    - name: Get SHA
      id: sha
      run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Build Docker images
      if: steps.check-cluster.outputs.cluster_exists == 'true'
      run: |
        docker build -t gcr.io/${{ env.PROJECT_ID }}/multi-client:latest -t gcr.io/${{ env.PROJECT_ID }}/multi-client:${{ steps.sha.outputs.sha }} -f ./client/Dockerfile ./client
        docker build -t gcr.io/${{ env.PROJECT_ID }}/multi-server:latest -t gcr.io/${{ env.PROJECT_ID }}/multi-server:${{ steps.sha.outputs.sha }} -f ./server/Dockerfile ./server
        docker build -t gcr.io/${{ env.PROJECT_ID }}/multi-worker:latest -t gcr.io/${{ env.PROJECT_ID }}/multi-worker:${{ steps.sha.outputs.sha }} -f ./worker/Dockerfile ./worker

    - name: Push Docker images
      if: steps.check-cluster.outputs.cluster_exists == 'true'
      run: |
        docker push gcr.io/${{ env.PROJECT_ID }}/multi-client:latest
        docker push gcr.io/${{ env.PROJECT_ID }}/multi-client:${{ steps.sha.outputs.sha }}
        docker push gcr.io/${{ env.PROJECT_ID }}/multi-server:latest
        docker push gcr.io/${{ env.PROJECT_ID }}/multi-server:${{ steps.sha.outputs.sha }}
        docker push gcr.io/${{ env.PROJECT_ID }}/multi-worker:latest
        docker push gcr.io/${{ env.PROJECT_ID }}/multi-worker:${{ steps.sha.outputs.sha }}

    - name: Create PostgreSQL Secret
      if: steps.check-cluster.outputs.cluster_exists == 'true'
      run: |
        kubectl get secret pgpassword &>/dev/null || \
        kubectl create secret generic pgpassword \
          --from-literal=PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }}

    - name: Deploy to GKE
      if: steps.check-cluster.outputs.cluster_exists == 'true'
      run: |
        kubectl apply -f k8s/
        kubectl set image deployments/client-deployment client=gcr.io/${{ env.PROJECT_ID }}/multi-client:${{ steps.sha.outputs.sha }}
        kubectl set image deployments/server-deployment server=gcr.io/${{ env.PROJECT_ID }}/multi-server:${{ steps.sha.outputs.sha }}
        kubectl set image deployments/worker-deployment worker=gcr.io/${{ env.PROJECT_ID }}/multi-worker:${{ steps.sha.outputs.sha }}
        kubectl rollout status deployment/client-deployment
        kubectl rollout status deployment/server-deployment
        kubectl rollout status deployment/worker-deployment